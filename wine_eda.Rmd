---
title: "Kaggle Wine EDA"
author: "by Data Wine'ing"
date: "3/5/2020"
output:
  html_document:
    code_folding: hide
    # number_sections: true
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r Preample, include = F}

# knitr settings 
knitr::opts_chunk$set(fig.width = 12, fig.height = 4,
  warning=FALSE, message=FALSE, echo = FALSE)

# set working directory 
setwd("~/Desktop/Git/edwinbet")
source("eda_functions.R")

# load packages 
loadPkg(tidyverse)
loadPkg(gridExtra)
loadPkg(ggExtra)
loadPkg(kableExtra)
loadPkg(xtable)
loadPkg(gganimate)

```


```{r Data, include = F}
# load data 
raw_wine_reviews <- read.csv("data/winemag-data-130k-v2.csv")

# look at structure 
as.tibble(raw_wine_reviews)
```

<!-- ------------------------------------------------------------------
SLIDE 4
------------------------------------------------------------------ -->

### Glimpse of the Dataset
```{r Glimpse, echo = F}
raw_wine_reviews %>%
  select(title, country, province, points, price) %>%
  setNames(c("Title", "Country", "Province", "Points", "Price")) %>% 
  slice(1:7) %>%
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = F,
  position = "left")
```

<!-- ------------------------------------------------------------------
SLIDES 5 - 7 
------------------------------------------------------------------ -->

###  Descriptive Statistic 
```{r Descriptive statistics}

# Creat year variable 
wine_reviews <- raw_wine_reviews %>% 
  mutate(year = as.integer(str_extract(title, "\\-*\\d+\\.*\\d*"))) %>% 
  mutate(year = ifelse(year > 1950 & year < 2017, year, NA))

# Filter for outliers 
wine_reviews <- wine_reviews %>% 
  filter_outliers(price) %>% 
  filter_outliers(year) 

# Summary statistics of  year, points, and price 
wine_reviews %>% 
  select(year, points, price) %>% 
  setNames(c("Year", "Points", "Price")) %>% 
  summary() %>% 
  kable() %>% 
  kable_styling(bootstrap_options = "striped", full_width = F,
  position = "left")

```


### Graphical Representation of Price 
```{r Normality tests I }
# Box Plot 
box <- wine_reviews %>%
  wine_box(price, title = "Price", fill = "#ffd1d1", col = "#811f1f")

# QQ Plot 
qq <- wine_reviews %>%
  wine_qq(price, "Price")

# Histogram 
hist <- wine_reviews %>% 
  wine_hist(price, "Price", bins = 12, fill = "#ffd1d1", col = "#811f1f")

lay <- rbind(c(1,2), c(1,3))
grid.arrange(grobs = list(hist, qq, box), layout_matrix = lay)

```

### Graphical Representation of Year
```{r Normality tests II}
# Box Plot 
box <- wine_reviews %>%
  wine_box(year, title = "Year", fill = "#ffd1d1", col = "#811f1f")

# QQ Plot 
qq <- wine_reviews %>%
  wine_qq(year, "Year")

# Histogram 
hist <- wine_reviews %>% 
  wine_hist(year, "Year", bins = 12, fill = "#ffd1d1", col = "#811f1f")

lay <- rbind(c(1,2), c(1,3))
grid.arrange(grobs = list(hist, qq, box), layout_matrix = lay)
```

### Graphical Representation of Points  
```{r Normality tests III}
# Box Plot 
box <- wine_reviews %>%
  wine_box(points, title = "Points", fill = "#ffd1d1", col = "#811f1f")

# QQ Plot 
qq <- wine_reviews %>%
  wine_qq(points, "Points")

# Histogram 
hist <- wine_reviews %>% 
  wine_hist(points, "Points", bins = 12, fill = "#ffd1d1", col = "#811f1f")

lay <- rbind(c(1,2), c(1,3))
grid.arrange(grobs = list(hist, qq, box), layout_matrix = lay)
```

<!-- ------------------------------------------------------------------
SLIDE 5 - 8
------------------------------------------------------------------ -->

### Barplot of Wine Production
```{r Barplots }

top_10 <- wine_reviews %>%
  group_by(country) %>% 
  summarise(count = n()/ 129971) %>% 
  mutate(count = round(count, 2)) %>% 
  arrange(desc(count)) %>% 
  head(5) 

p1 <- ggplot(data = top_10, aes(x = reorder(country, -count), y = count),
  fill = country) +
  geom_bar(stat="identity",  fill = "#ffd1d1", col = "#811f1f") +
  labs(title = "Proportion of Total Wine Reviews \n by Country", 
  x = "Country", y = "Percentage") + ylim(0.0, 0.6) +
  geom_text(aes(label= count), vjust = -0.75, color="black" , size=3.5)+
  theme_minimal()

top_10 <- wine_reviews %>%
  filter(country == "US" & !province == "America") %>% 
  group_by(province) %>% 
  summarise(count = n()/ 54504) %>% 
  mutate(count = round(count, 2)) %>% 
  arrange(desc(count)) %>% 
  head(5) 

p2 <- ggplot(data = top_10, aes(x = reorder(province, -count), y = count),
  fill = province) +
  geom_bar(stat="identity",  fill = "#ffd1d1", col = "#811f1f") +
  labs(title = "Proportion of Total Wine Reviews \n in the US by State", 
  x = "State", y = "Percentage") + ylim(0.0, 0.8) +
  geom_text(aes(label= count), vjust = -0.75, color="black" , size=3.5)+
  theme_minimal()

grid.arrange(p1, p2, ncol = 2)
```
 
 <!-- ------------------------------------------------------------------
SLIDE 10
------------------------------------------------------------------ -->
 
### Bartlett Test Of Homogeneity Of Variance

```{r Bartlett}
# Bartlett 
big_wine <- wine_reviews %>% filter(country %in% c("Italy", "France", "US")) 
bartlett.test(big_wine$points, big_wine$country) 
```
 
### Overlayed Histagram

```{r Overlayed Histagram}
# Renamed variables 
wine_reviews <- wine_reviews %>% 
  mutate(region  = case_when(
    province == "California" ~ "California",
    country == "France" ~ "France", 
    country == "Italy" ~ "Italy"))

# Hist 
wine_reviews %>% 
  filter(!is.na(region)) %>% 
  ggplot(aes(x = points, colour = region)) +
  geom_density() + theme_minimal() + theme(text = element_text(size = 14),
  legend.position = c(0.8, 0.5)) + labs(title = "Distribution of Points by Region") + geom_vline(aes(xintercept= mean(points), color = region),
  linetype="dashed")

``` 


### Comparative Box Plots 
```{r}

# compare accross country
wine_reviews %>% 
  filter(!is.na(region)) %>% 
  ggplot(aes(x = region, y = points)) + 
  geom_boxplot(aes(color = region)) + 
  scale_color_manual(values = c("#00AFBB", "#E7B800", "#FC4E07")) + 
  theme_minimal()

# subset by group 
wine_reviews <- wine_reviews %>% 
 mutate(price_bucket = case_when(
   price < 15 ~ "less then $15",
   price %in% 15:29 ~ "$15 to $29",
   price %in% 30:44 ~ "$30 to $44", 
   price %in% 45:60 ~ "$45 to $60", 
   price > 60 ~ "greater than $60")
 ) %>% 
  mutate(price_bucket = factor(price_bucket, 
  levels = c("less then $15", "$15 to $29", "$30 to $44", 
    "$45 to $60", "greater than $60"))
  )

pallet <- c("#7A0177", "#C51B8A", "#F768A1", "#C51B8A","#7A0177")

# box plot by bucket 
ca <- wine_reviews %>% 
  filter(region == "California") %>% 
  ggplot(aes(x = price_bucket, y = points)) + labs(x = "California") +
  geom_boxplot(aes(col = price_bucket, fill = price_bucket, alpha = 0.15)) + 
  scale_color_manual(values = pallet) + scale_fill_manual(values = pallet) +
  theme_minimal() + theme(legend.position = "none")

it <- wine_reviews %>% 
  filter(region == "Italy") %>% 
  ggplot(aes(x = price_bucket, y = points)) + labs(x = "Italy") +
  geom_boxplot(aes(col = price_bucket, fill = price_bucket, alpha = 0.15)) + 
  scale_color_manual(values = pallet) + scale_fill_manual(values = pallet) +
  theme_minimal() + theme(legend.position = "none")

fr <- wine_reviews %>% 
  filter(region == "France") %>% 
  ggplot(aes(x = price_bucket, y = points)) + labs(x = "France") +
  geom_boxplot(aes(col = price_bucket, fill = price_bucket, alpha = 0.15)) + 
  scale_color_manual(values = pallet) + scale_fill_manual(values = pallet) +
  theme_minimal() + theme(legend.position = "none")

ca 
it 
fr

```

 
 
### Anova 

Interpretation: The p-value is lower than the usual threshold of 0.05. You are confident to say there is a statistical difference between the groups

```{r Anova }
# subset 
big_wine <- wine_reviews %>% 
  filter(country %in% c("Italy", "France", "US")) 

# anova 
anova_results <- aov(points ~ country, data = big_wine)
summary(anova_results) 
```

 <!-- ------------------------------------------------------------------
SLIDE 11
------------------------------------------------------------------ -->

### Two Sample T-Test 

```{r}

california <- wine_reviews %>% filter(province == "California") 
italy <-  wine_reviews %>% filter(country == "Italy")
france <-  wine_reviews %>% filter(country == "France")

# tests 
t.test(california$points, italy$points, var.equal = F) 
t.test(california$points, france$points, var.equal = F) 

# histograms 
p1 <- wine_reviews %>% 
  filter(region %in% c("France", "California")) %>% 
  ggplot(aes(x = points, colour = region)) +
  geom_density() + theme_minimal() + theme(text = element_text(size = 14),
  legend.position = c(0.8, 0.5)) + labs(title = "Distribution of Points by Region") + geom_vline(aes(xintercept= mean(points), color = region),
  linetype="dashed")

p2 <- wine_reviews %>% 
  filter(region %in% c("Italy", "California")) %>% 
  ggplot(aes(x = points, colour = region)) +
  geom_density() + theme_minimal() + theme(text = element_text(size = 14),
  legend.position = c(0.8, 0.5)) + labs(title = "Distribution of Points by Region") + geom_vline(aes(xintercept= mean(points), color = region),
  linetype="dashed")

grid.arrange(p1, p2, ncol = 1)
```

 <!-- ------------------------------------------------------------------
SLIDE 12
------------------------------------------------------------------ -->

### Regression Model 

```{r}

model <- wine_reviews %>%
  mutate(yearDemeaned = year - 2010.682) %>% 
  filter(region %in% c("Italy", "France", "California")) %>% 
  lm(formula = points ~ region + price + year) 

summary(model) %>% 
  xtable() %>% 
  kable(digits = 3) %>%
  kable_styling(bootstrap_options = "striped", full_width = F,
  position = "left")
```

<!-- ------------------------------------------------------------------
ADDITIONAL GRAPHICS
------------------------------------------------------------------ -->

### Scatter Plots
```{r}

# price  vs. points
wine_reviews %>%
  filter(region == "California") %>% 
  ggplot(aes(x = price, y = points)) +
  geom_point(show.legend = FALSE, alpha = 0.7) +
  geom_smooth(method=lm)

# price  vs. points grouped by region (not so informative)
wine_reviews %>%
  ggplot(aes(x = price, y = points, color = region)) +
  geom_point(show.legend = FALSE, alpha = 0.7) +
  geom_smooth(method=lm)

# year  vs. points
wine_reviews %>%
  filter(region == "California") %>% 
  ggplot(aes(x = year, y = points)) +
  geom_point(show.legend = FALSE, alpha = 0.7) +
  geom_smooth(method=lm)

```

### Animated Bar Plot 
```{r}
wine_reviews %>% 
  filter(!is.na(region)) %>% 
  group_by(region, year) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = region, y = count, color = region, fill =
    region, alpha = 0.43)) + 
  geom_bar(stat="identity") + 
  transition_time(year) + 
  labs(title = "Year: {frame_time}") +
  theme_minimal() + 
  theme(legend.position = "none")
```




<!-- ------------------------------------------------------------------
END OF PRESENTATION 
------------------------------------------------------------------ -->












