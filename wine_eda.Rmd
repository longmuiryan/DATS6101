---
title: "Kaggle Wine EDA"
author: "by Data Wine'ing"
date: "3/5/2020"
output:
  html_document:
    code_folding: hide
    # number_sections: true
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r Preample, include = F}

# knitr settings 
knitr::opts_chunk$set(fig.width = 12, fig.height = 4,
  warning=FALSE, message=FALSE, echo = FALSE)

# set working directory 
setwd("~/Desktop/Git/edwinbet")

# load packages 
library(tidyverse, quietly = T)
library(gridExtra, quietly = T)
library(ggExtra)

# source files 
# source("leaflet_map.R")
source("plotting_functions.R")
```
## 0. Raw Data 
***

```{r Data, include = F}
raw_wine_reviews <- read.csv("data/winemag-data-130k-v2.csv")
```

### Data at a glance 
```{r Glimpse, echo = F}
as.tibble(raw_wine_reviews)
```


##  1. Descriptive Statistic: Global Perspective 
***

```{r Descriptive statistics}
# Creat year variable 
wine_reviews <- raw_wine_reviews %>% 
  mutate(year = as.numeric(str_extract(title, "\\-*\\d+\\.*\\d*"))) %>% 
  mutate(year = ifelse(year > 1950 & year < 2017, year, NA))

# Summary statistics of  year, points, and price 
wine_reviews %>% 
  select(year, points, price) %>% 
  summary()
```


## 2. Graphical Representation of Data & Normality Tests 
***

### Price 
```{r Normality tests I }

# Remove Outliers 
IQR <- IQR(wine_reviews$price, na.rm = T)
Q <- quantile(wine_reviews$price, probs=c(.25, .75), na.rm = T)
lower_bound <- Q[1] - 1.5*IQR
upper_bound <- Q[2] + 1.5*IQR

# Box Plot 
price_box <- wine_reviews %>%
  filter(lower_bound < price & upper_bound > price) %>%
  wine_box(price, title = "Price")

# QQ Plot 
price_qq <- wine_reviews %>%
  filter(lower_bound < price & upper_bound > price) %>%
  wine_qq(price, "Points")

# Histogram 
price_hist <- wine_reviews %>% 
  filter(lower_bound < price & upper_bound > price) %>%
  wine_hist(price, "Price", bins = 20)

grid.arrange(price_box, price_qq, price_hist, ncol = 3 )

lay <- rbind(c(1,2), c(1,3))
grid.arrange(grobs = list(price_box, price_qq, price_hist), layout_matrix = lay)
```

### Year
```{r Normality tests II}
year_box <-  wine_reviews %>% wine_box(year, "Year")
year_qq <-  wine_reviews %>% wine_qq(year, "Year")
year_hist <-  wine_reviews %>% wine_hist(year, "Year", bins = 40)
grid.arrange(year_box, year_qq, year_hist, ncol=3 )
```

### Points 
```{r Normality tests III}
points_box <- wine_reviews %>% wine_box(points, "Points")
points_qq <- wine_reviews %>% wine_qq(points, "Points")
points_hist <- wine_reviews %>% wine_hist(points, "Points", bins = 20)
grid.arrange(points_box, points_qq, points_hist, ncol=3 )
```


## 3. Initial correlation / Chi Square tests / ANOVA analysis / Z-test or Z-interval / T-test or T-interval etc. 
***

### Price vs. points 

Interpretation: Wines over \$300 dollars are typically >90pts, not suprising. However, There's a great variation in points among wines less that \$100. What counties in California produce the highest rated wines that cost less than \$50? 

```{r Correlation I}
# Scatter plot 
wine_reviews  %>% 
  filter(price < 500) %>% 
  ggplot(aes(x = price, y= points)) + 
  geom_point() +
  geom_smooth(method = lm, se = FALSE)

# Correlation points vs. price
cor.test(wine_reviews$price, wine_reviews$points)
```

### Price vs. years 

Interpretation: Not very fitted, does imply that the year a wine was produced has influence on how it's rated

```{r Correlation II}

# Remove Outliers 
IQR <- IQR(wine_reviews$price, na.rm = T)
Q <- quantile(wine_reviews$price, probs=c(.25, .75), na.rm = T)
lower_bound <- Q[1]- 1.5*IQR
upper_bound <- Q[2] + 1.5*IQR

# Scatter plot 
price_scatter <- wine_reviews %>% 
  filter(lower_bound < price & upper_bound > price & !is.na(price) & !is.na(year)) %>%
  ggplot(aes(x = year, y= price)) + 
  geom_count()  +
  geom_smooth(method = lm, se = FALSE)

# Correlation 
cor.test(wine_reviews$year, wine_reviews$points)
```

### Two Sample T 

Interpretation: The p-value is lower than the usual threshold of 0.05. You are confident to say there is a statistical difference between the groups

```{r Two sample t-test}
# subset  
domestic_wines <- wine_reviews %>% filter(country == "US")
imported_wines <- wine_reviews %>% filter(country != "US")

# t-test 
t.test(domestic_wines$points, imported_wines$points)
```


### Anova 
Interpretation: The p-value is lower than the usual threshold of 0.05. You are confident to say there is a statistical difference between the groups
```{r Anova }
# subset 
big_wine <- wine_reviews %>% 
  filter(country %in% c("Italy", "Spain", "France", "US")) 

# anova 
anova_results <- aov(points ~ country, data = big_wine)
summary(anova_results) 
```

### Who makes the most >80pt wine?

You'd think it might be Italy but the answer might suprise you. Source: https://en.wikipedia.org/wiki/List_of_wine-producing_regions

Note: Do we think Italy makes less >80pt wine or could it be that Wine Enthusiast is more likely to review a bottle of wine from the United States? This could potentially be a point of bias in our sample. 

```{r Count}
raw_wine_reviews %>%
  group_by(country) %>% 
  summarise(count = n()) %>% 
  arrange(desc(count)) %>% 
  head(10)
```

## Barplot 
*** 

```{r}

sum_of_reviews <- raw_wine_reviews %>% 
  summarise(count= n()) %>% 
  print()

top_10 <- raw_wine_reviews %>%
  group_by(country) %>% 
  summarise(count = n()/ 129971) %>% 
  mutate(count = round(count, 2)) %>% 
  arrange(desc(count)) %>% 
  head(10) 

ggplot(data = top_10, aes(x = reorder(country, -count), y = count), fill = country) +
  geom_bar(stat="identity", fill = "#9a2140") +
  labs(title = "Proportion of Total Wine Reviews by Country", 
  x = "Country", y = "Percentage") +
  geom_text(aes(label= count), vjust=1.3, color="white", size=3.5)+
  theme_minimal()

```



```{r}

sum_of_reviews <- raw_wine_reviews %>% 
  summarise(count= n()) %>% 
  print()

top_10 <- raw_wine_reviews %>%
  filter(country == "US" & province != "America") %>% 
  group_by(province) %>%
  summarise(count = n()/ 129971) %>% 
  mutate(count = round(count, 2)) %>% 
  arrange(desc(count)) %>% 
  head(10) 

ggplot(data = top_10, aes(x = reorder(province, -count), y = count), fill =  province) +
  geom_bar(stat="identity", fill = "#9a2140") +
  labs(title = "Proportion of US Wine Reviews by State", 
  x = "State", y = "Percentage") +
  geom_text(aes(label = count), vjust = 1.3, color= "white", size =   3.5) +
  theme_minimal()


```



```{r}
# Overlapping Histogram

# ------------------------------------------------------------
# points
# ------------------------------------------------------------

# Bounds 
IQR <- IQR(raw_wine_reviews$points, na.rm = T)
Q <- quantile(raw_wine_reviews$points, probs=c(.25, .75), na.rm = T)
lower_bound <- Q[1] - 1.5*IQR
upper_bound <- Q[2] + 1.5*IQR

# Renamed variables 
price_filtered_wine_reviews <- raw_wine_reviews %>% 
  mutate(Region  = case_when(
    province == "California" ~ "California",
    country == "France" ~ "France", 
    country == "Italy" ~ "Italy"))

# Hist 
p1 <- price_filtered_wine_reviews %>% 
  filter(lower_bound < price & upper_bound > price) %>%
  filter(!is.na(Region)) %>% 
  ggplot(aes(x = points, colour = Region)) +
  geom_density() + theme_minimal()

# ------------------------------------------------------------
# price 
# ------------------------------------------------------------

# Bounds 
IQR <- IQR(raw_wine_reviews$price, na.rm = T)
Q <- quantile(raw_wine_reviews$price, probs = c(.25, .75), na.rm = T)
lower_bound <- Q[1] - 1.5*IQR
upper_bound <- Q[2] + 1.5*IQR

# Renamed variables 
filter_price_wine_reviews <-raw_wine_reviews %>% 
  mutate(Region  = case_when(
    province == "California" ~ "California",
    country == "France" ~ "France", 
    country == "Italy" ~ "Italy"))

# Hist 
p2 <- filter_price_wine_reviews %>% 
  filter(lower_bound < price & upper_bound > price) %>%
  filter(!is.na(Region)) %>% 
  ggplot(aes(x = price, colour = Region)) +
  geom_density() + theme_minimal()

grid.arrange(p1, p2, ncol = 1 )

```
