---
title: "R Notebook"
output: html_notebook
---


```{r}
knitr::opts_chunk$set(warning = F, results = 'markup', message = F)
options(scientific=T, digits = 3) 

loadPkg = function(pkg, character.only = FALSE) { 
  if (!character.only) { pkg <- as.character(substitute(pkg)) }
  pkg <- ifelse(!character.only, as.character(substitute(pkg)) , pkg)  
  if (!require(pkg,character.only=T, quietly =T)) {  install.packages(substitute(pkg),dep=T); if(!require(pkg,character.only=T)) stop("Package not found") } 
}
loadPkg(knitr)
# unload/detact package when done using it
unloadPkg = function(pkg, character.only = FALSE) { 
  if(!character.only) { pkg <- as.character(substitute(pkg)) } 
  search_item <- paste("package", pkg,sep = ":") 
  while(search_item %in% search()) { detach(search_item, unload = TRUE, character.only = TRUE) } 
}


loadPkg(xtable)
loadPkg(kableExtra)
loadPkg(stringi)

xkabledply = function(modelsmmrytable, title="Table", digits = 4, pos="left", bso="striped") { 

  modelsmmrytable %>%
    xtable() %>% 
    kable(caption = title, digits = digits) %>%
    kable_styling(bootstrap_options = bso, full_width = FALSE, position = pos)
}

xkablesummary = function(df, title="Table: Statistics summary.", digits = 4, pos="left", bso="striped") { 

  s = summary(df) %>%
    apply( 2, function(x) stringr::str_remove_all(x,c("Min.\\s*:\\s*","1st Qu.\\s*:\\s*","Median\\s*:\\s*","Mean\\s*:\\s*","3rd Qu.\\s*:\\s*","Max.\\s*:\\s*")) ) %>% 
    apply( 2, function(x) stringr::str_trim(x, "right")) # trim trailing spaces left
  
  colnames(s) <- stringr::str_trim(colnames(s))
  
  if ( dim(s)[1] ==6 ) { rownames(s) <- c('Min','Q1','Median','Mean','Q3','Max') 
  } else if ( dim(s)[1] ==7 ) { rownames(s) <- c('Min','Q1','Median','Mean','Q3','Max','NA') }
  
  xkabledply(s, title=title, digits = digits, pos=pos, bso=bso )
}


loadPkg("tidyverse")
loadPkg("factoextra")

winedata <- read.csv("~/Documents/DATS6101/edwinbet/data/wine_reviews.csv")
# wine1 <- na.omit(winedata)
# wine2 <- wine1[ -c(1,3,11,12) ]
wine <- winedata %>% 
 # dplyr::mutate(
 #    red = ifelse(color == "red", 1, 0),
 #    dom = ifelse(country == "US", 1, 0)
 #  ) %>%
 dplyr::select(
    points, price, year, taster_following,
    comp_el, comp_lat, comp_lon
  ) %>% 
 mutate_all(as.numeric) %>% 
 filter_all(function(x){!is.na(x)}) 

glimpse(wine)


# Remove Outliers
outliers <- boxplot(wine$price, plot=FALSE)$out
wine2<- wine[-which(wine$price %in% outliers),]

```

###K-Means

```{r}
set.seed(1000)
# wine_review <- scale(wine2)
# head(wine)


# function to compute total within-cluster sum of square
wss <- function(k) {
  kmeans(wine2, k, nstart = 10 )$tot.withinss
}

# Compute and plot wss for k = 1 to k = 15
k.values <- 1:15

# extract wss for 2-15 clusters
wss_values <- map_dbl(k.values, wss)

plot(k.values, wss_values,
       type="b", pch = 19, frame = FALSE,
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")

#nstart is just the number of configurations, we dont really need that
k <- kmeans(wine2, centers = 5)
print(k)

# plots to compare
fviz_cluster(k, geom = "point",  data = wine2) + ggtitle("k = 5")

#Cluster Mean
k$centers
#Number of values in each cluster
k$size

# https://uc-r.github.io/kmeans_clustering
```


```{r}

# kable(summarize(k, type = 'numeric'),format = 'html') %>%
#   kable_styling(bootstrap_options = c("striped", "hover"))
# 
# GroupsSummary <- describeBy(cluster.c[,1:10], cluster.c[,'Points'])
# 
# kable(GroupsSummary[[1]], format = "html", digits = 2) %>%
#   kable_styling(bootstrap_options = c("striped", "hover"))

cluster <- data.frame(k$cluster)

ggplot(cluster, aes(x=variable, y=value)) +
  geom_boxplot(aes(fill = Group),outlier.size = 1) +
  facet_wrap( ~ variable, scales="free", ncol = 2) +
  xlab(label = NULL) + ylab(label = NULL) + ggtitle("Boxplots for 3 Groups of Clients") +
  guides(fill=guide_legend(title="Groups"))


xkablesummary(wine2)

wine_cluster_description_mean <- wine2 %>% 
  mutate(Cluster = k$cluster) %>%
  group_by(Cluster) %>%
  summarize_all('mean')

wine_cluster_description_mean

wine_cluster_description_median <- wine2 %>% 
  mutate(Cluster = k$cluster) %>%
  group_by(Cluster) %>%
  summarize_all('median')

wine_cluster_description_median

wine_cluster_description_max <- wine2 %>% 
  mutate(Cluster = k$cluster) %>%
  group_by(Cluster) %>%
  summarize_all('max')

wine_cluster_description_max

wine_cluster_description_min <- wine2 %>% 
  mutate(Cluster = k$cluster) %>%
  group_by(Cluster) %>%
  summarize_all('min')

wine_cluster_description_min


```















_______________________________________________________________________________________________
_______________________________________________________________________________________________

###Feature Selection
```{r}
# loadPkg("corrplot")
# loadPkg("leaps")
# loadPkg(faraway)
# loadPkg(car)
# 
# corr <-cor(wine2) 
# corrplot(corr, type = "upper")
# 
# reg1 <- regsubsets(wine2$points~. , data = wine2, nvmax = 9, nbest = 2, method = "exhaustive") 
# (summary(reg1))
# plot(reg1, scale = "adjr2", main = "Adjusted R^2")
# 
# fit1 <- glm(wine2$points ~ points + price + year + taster_following + composite_el + composite_lat + composite_lon, data = wine2)
# summary(fit1)
# vif(fit1)
# plot(reg1, scale = "bic", main = "BIC")
# 
# subsets(reg1, statistic="adjr2", legend = FALSE, min.size = 3, main = "Adjusted R^2")
# abline(a = 1, b = 1, lty = 2)  
```


Based on the correlation matrix, we learn that points has a statistically significant linear relationship with the variables: price, composite_lat, and taster_name, taste_following. While the results of regression confirms the relationship between independent variables and dependent variables, the correlation analysis allows us to identify the variable that will have a direct impact on the quality points. The output of this analysis confirmed price as a strong predictor of points: the best wines are the wines that were properly fermented or aerated, requiring time and real estate, and thus, increasing the cost of production. The second variable identified by the correlation region, plays a significant role in the analysis as the quality of wine depends on several factors such as climate, elevation, type of grape and soil; producing wines in regions where the climate is incompatible with wine grapes will deprive the grape from a favorable growth environment. Finally, the reviewer taste plays an apparent bias in point assignment. If a reviewer prefers sugary wines, the odds of them assigning a lower score to a tart-ier wine is fairly high.


### Relationship between wine reviwers and taste
```{r}
# loadPkg("corrplot")
# loadPkg("leaps")
# loadPkg(faraway)
# loadPkg(car)
# 
# wine_reviewer_info <- winedata %>% 
#  # dplyr::mutate(
#  #    red = ifelse(color == "red", 1, 0),
#  #    dom = ifelse(country == "US", 1, 0)
#  #  ) %>%
#  dplyr::select(
#     acidity, tannins, cherry, ripe, spice, oak, fresh, rich, dry, berry, plum, soft, apple, fruits, sweet, crisp, blackberry, light, dark, citrus, bodied, vanilla, bright, pepper, green, lemon, raspberry, peach, chocolate, dried, pear, taster_following, Alexander.Peartree, Anna.Lee.C.Iijima, Anne.Krebiehl.MW, Carrie.Dykes,
#   ) %>% 
#  mutate_all(as.numeric) %>% 
#  filter_all(function(x){!is.na(x)}) 
# 
# glimpse(wine_reviewer_info)


```